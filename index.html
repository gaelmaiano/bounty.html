<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BountyAcademy - Labs Cybersec</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 16rem; background-color: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 20; transition: transform 0.3s; }
        .sidebar-header { padding: 1.5rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid #334155; }
        .sidebar-header h1 { font-size: 1.2rem; color: white; font-weight: bold; }
        
        /* XP Panel */
        .xp-panel { padding: 1rem; background: rgba(30, 41, 59, 0.5); margin: 1rem; border-radius: 0.5rem; border: 1px solid #475569; }
        .xp-bar-container { width: 100%; background: #334155; height: 0.5rem; border-radius: 10px; overflow: hidden; margin: 0.5rem 0; }
        .xp-bar { background: #10b981; height: 100%; width: 0%; transition: width 0.5s; }
        .xp-info { display: flex; justify-content: space-between; font-size: 0.75rem; color: #94a3b8; }

        /* Navigation */
        .nav-section { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
        .nav-btn { width: 100%; text-align: left; padding: 0.75rem 1.5rem; color: #94a3b8; background: none; border: none; border-left: 4px solid transparent; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-btn:hover, .nav-btn.active { color: #34d399; background: #1e293b; border-left-color: #10b981; }
        .module-progress { margin-left: auto; font-size: 0.7rem; color: #64748b; }

        /* Main Content */
        .main-content { flex: 1; overflow-y: auto; position: relative; }
        .content-area { padding: 2rem; max-width: 64rem; margin: 0 auto; }
        .mobile-header { display: none; padding: 1rem; background: #1e293b; justify-content: space-between; align-items: center; }
        
        /* Cards */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: rgba(30, 41, 59, 0.7); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.05); }
        .module-card { background: #1e293b; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; border: 1px solid #475569; }
        .module-card:hover { border-color: #10b981; transform: translateX(5px); transition: transform 0.2s; }

        /* Labs UI */
        .lab-container { background: #1e293b; border: 1px solid #475569; border-radius: 0.5rem; padding: 1.5rem; margin-top: 1rem; }
        .lab-browser { background: #f8fafc; border-radius: 0.5rem; overflow: hidden; color: #334155; font-family: sans-serif; border: 1px solid #cbd5e1; }
        .browser-bar { background: #e2e8f0; padding: 0.5rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid #cbd5e1; }
        .url-bar { background: white; padding: 0.2rem 0.5rem; border-radius: 4px; flex: 1; font-size: 0.8rem; color: #64748b; border: 1px solid #cbd5e1; }
        .browser-content { padding: 2rem; min-height: 200px; text-align: center; }
        
        /* Inputs & Buttons */
        .vulnerable-input { padding: 0.75rem; border: 2px solid #cbd5e1; border-radius: 4px; width: 70%; margin-right: 0.5rem; }
        .vulnerable-btn { padding: 0.75rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .action-btn { width: 100%; padding: 1rem; background: #059669; color: white; border: none; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem; }
        .action-btn:disabled { background: #334155; cursor: not-allowed; }

        /* Specific Lab Styles */
        .profile-card { border: 1px solid #cbd5e1; border-radius: 8px; padding: 20px; max-width: 400px; margin: 0 auto; background: white; text-align: left; }
        .xxe-output, .lfi-file-content, .race-output { margin-top: 1.5rem; padding: 1rem; background: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 4px; text-align: left; min-height: 100px; font-family: monospace; white-space: pre-wrap; }
        .xxe-success { color: #10b981; font-weight: bold; }
        .shop-product-received { display: inline-block; background: #334155; padding: 0.5rem; margin: 0.2rem; border-radius: 4px; color: white; font-size: 0.8rem; }
        
        /* Race Condition specific */
        .race-controls { display: flex; gap: 0.5rem; margin: 1rem 0; }
        .race-track { background: #e2e8f0; height: 20px; border-radius: 10px; margin: 0.5rem 0; position: relative; overflow: hidden; }
        .race-progress { background: #3b82f6; height: 100%; width: 0%; transition: width 0.1s; }
        .request-indicator { position: absolute; top: -5px; width: 30px; height: 30px; background: #ef4444; border-radius: 50%; transform: translateX(-15px); }
        
        /* Toast & Alerts */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; border-left: 4px solid #10b981; color: white; padding: 15px 20px; border-radius: 4px; transform: translateX(150%); transition: transform 0.3s; z-index: 100; }
        .toast.show { transform: translateX(0); }
        .fake-alert-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; }
        .fake-alert-box { background: white; padding: 1.5rem; border-radius: 0.5rem; width: 300px; text-align: center; color: #0f172a; }

        /* Mobile */
        @media (max-width: 768px) {
            .sidebar { position: fixed; transform: translateX(-100%); height: 100vh; width: 80%; }
            .sidebar.mobile-open { transform: translateX(0); }
            .mobile-header { display: flex; }
            .stats-grid { grid-template-columns: 1fr; }
            .vulnerable-input { width: 100%; margin-bottom: 0.5rem; }
        }
    </style>
</head>
<body>

    <div class="app-container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <i class="fa-solid fa-bug" style="color:#10b981"></i>
                <h1>BountyAcademy</h1>
            </div>
            <div class="xp-panel">
                <div class="xp-info"><span>Niveau</span><span id="user-level">Novice</span></div>
                <div class="xp-bar-container"><div id="xp-bar" class="xp-bar"></div></div>
                <div class="xp-info"><span id="current-xp">0 XP</span><span>3000 XP</span></div>
            </div>
            <div class="nav-section" id="nav-buttons">
                </div>
        </nav>

        <main class="main-content">
            <div class="mobile-header">
                <span style="color:white; font-weight:bold;">BountyAcademy</span>
                <button onclick="toggleSidebar()" style="background:none; border:none; color:white; font-size:1.5rem;"><i class="fa-solid fa-bars"></i></button>
            </div>
            <div id="content-area" class="content-area"></div>
        </main>
    </div>

    <div id="toast" class="toast"><span id="toast-message"></span></div>
    <div id="fake-alert-overlay" class="fake-alert-overlay">
        <div class="fake-alert-box">
            <h3 style="color:#ef4444; margin-bottom:1rem;">⚠️ Alert</h3>
            <p id="alert-content" style="background:#f1f5f9; padding:0.5rem; font-family:monospace; margin-bottom:1rem;">1</p>
            <button class="vulnerable-btn" onclick="closeFakeAlert()">OK</button>
        </div>
    </div>

    <script>
        // --- ETAT DE L'APPLICATION ---
        const appState = {
            xp: 0,
            level: 1,
            completedModules: [],
            currentView: 'dashboard',
            // État pour la Race Condition
            raceStock: 5,
            raceUserMoney: 1000,
            raceInventory: 0
        };

        // --- DONNÉES DES MODULES ---
        const modulesData = [
            { id: 'xss', title: 'Lab 1: XSS Reflected', icon: 'code', color: '#10b981', xp: 200, level: 'Facile' },
            { id: 'idor', title: 'Lab 2: IDOR', icon: 'id-card', color: '#f59e0b', xp: 300, level: 'Moyen' },
            { id: 'sqli', title: 'Lab 3: SQL Injection', icon: 'database', color: '#ef4444', xp: 400, level: 'Intermédiaire' },
            { id: 'csrf', title: 'Lab 4: CSRF', icon: 'hand-pointer', color: '#3b82f6', xp: 400, level: 'Avancé' },
            { id: 'xxe', title: 'Lab 5: XXE', icon: 'file-code', color: '#fbbf24', xp: 500, level: 'Expert' },
            { id: 'rc', title: 'Lab 6: Race Condition', icon: 'gauge-high', color: '#ef4444', xp: 600, level: 'Expert+' },
            { id: 'lfi', title: 'Lab 7: LFI', icon: 'folder-open', color: '#34d399', xp: 600, level: 'Intermédiaire' }
        ];

        // --- FONCTIONS UTILITAIRES ---
        function escapeHtml(text) {
            if (!text) return text;
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function getBackButton() {
            return '<button onclick="navigateTo(\'dashboard\')" class="vulnerable-btn" style="margin-bottom:1rem;"><i class="fa-solid fa-arrow-left"></i> Retour</button>';
        }

        function getValidateButton(moduleId) {
            const completed = appState.completedModules.includes(moduleId);
            return `
                <button class="action-btn" onclick="validateModule('${moduleId}')" ${completed ? 'disabled' : ''}>
                    ${completed ? '<i class="fa-solid fa-check"></i> Déjà validé' : 'Valider le lab'}
                </button>
            `;
        }

        // --- RENDU DES VUES (HTML) ---
        const views = {
            dashboard: () => {
                let html = `
                    <h2 class="dashboard-title">Tableau de bord</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><div style="color:#94a3b8">XP Total</div><div style="font-size:1.8rem; font-weight:bold; color:white;">${appState.xp}</div></div>
                        <div class="stat-card"><div style="color:#94a3b8">Labs Terminés</div><div style="font-size:1.8rem; font-weight:bold; color:white;">${appState.completedModules.length}/7</div></div>
                    </div>
                    <h3 style="color:white; margin-bottom:1rem;">Modules</h3>`;
                
                modulesData.forEach(m => {
                    const isCompleted = appState.completedModules.includes(m.id);
                    const borderColor = isCompleted ? '#10b981' : '#475569';
                    html += `
                    <div class="module-card" style="border-color:${borderColor}" onclick="navigateTo('module-${m.id}')">
                        <div style="display:flex; align-items:center; gap:1rem;">
                            <div style="width:3rem; height:3rem; background:#334155; border-radius:50%; display:flex; align-items:center; justify-content:center; color:${m.color}"><i class="fa-solid fa-${m.icon}"></i></div>
                            <div><h4 style="color:white; margin:0;">${m.title}</h4><span style="font-size:0.8rem; color:#94a3b8;">${m.level} • ${m.xp} XP</span></div>
                        </div>
                        <i class="fa-solid fa-chevron-right" style="color:#475569"></i>
                    </div>`;
                });
                return html;
            },
            
            'module-xss': () => `
                ${getBackButton()}
                <h2 style="color:white; margin-bottom:1rem;">Lab 1: XSS Reflected</h2>
                <div class="lab-container">
                    <div style="margin-bottom:0.5rem; color:#94a3b8;">Mission: Faire apparaître une <code>alert(1)</code> via la recherche.</div>
                    <div class="lab-browser">
                        <div class="browser-bar"><div class="url-bar">/search</div></div>
                        <div class="browser-content">
                            <h3>Super Search</h3>
                            <input type="text" id="xss-input" class="vulnerable-input" placeholder="Rechercher..." value="">
                            <button onclick="runXSS()" class="vulnerable-btn">Go</button>
                            <div id="xss-result" style="margin-top:1rem;"></div>
                            <div style="margin-top:1rem; font-size:0.8rem; color:#64748b;">
                                <strong>Indice:</strong> Essayez <code>&lt;script&gt;alert(1)&lt;/script&gt;</code>
                            </div>
                        </div>
                    </div>
                </div>
                ${getValidateButton('xss')}
            `,
            
            'module-idor': () => `
                ${getBackButton()}
                <h2 style="color:white; margin-bottom:1rem;">Lab 2: IDOR</h2>
                <div class="lab-container">
                    <div style="margin-bottom:0.5rem; color:#94a3b8;">Mission: Accéder au profil ID 1234 (Admin). Votre ID est 1337.</div>
                    <div class="lab-browser">
                        <div class="browser-bar"><div class="url-bar">/profile?id=1337</div></div>
                        <div class="browser-content">
                            <h3>Profil Utilisateur</h3>
                            <div style="margin:1rem 0;">
                                <label>ID Profil à afficher:</label>
                                <input type="number" id="idor-input" class="vulnerable-input" value="1337" min="1">
                                <button onclick="loadIDORProfile()" class="vulnerable-btn">Charger</button>
                            </div>
                            <div id="idor-profile" class="profile-card">
                                </div>
                            <div style="margin-top:1rem; font-size:0.8rem; color:#64748b;">
                                <strong>Indice:</strong> Changez l'ID dans l'URL ou le champ de saisie
                            </div>
                        </div>
                    </div>
                </div>
                ${getValidateButton('idor')}
            `,
            
            'module-sqli': () => `
                ${getBackButton()}
                <h2 style="color:white; margin-bottom:1rem;">Lab 3: SQL Injection</h2>
                <div class="lab-container">
                    <div style="margin-bottom:0.5rem; color:#94a3b8;">Mission: Extraire les informations de la table "users".</div>
                    <div class="lab-browser">
                        <div class="browser-bar"><div class="url-bar">/login</div></div>
                        <div class="browser-content">
                            <h3>Login Admin</h3>
                            <div style="margin:1rem 0;">
                                <input type="text" id="sqli-user" class="vulnerable-input" placeholder="Username" value="admin">
                                <input type="password" id="sqli-pass" class="vulnerable-input" placeholder="Password" style="margin-top:0.5rem;" value="">
                                <button onclick="runSQLI()" class="vulnerable-btn" style="margin-top:0.5rem;">Login</button>
                            </div>
                            <div id="sqli-result" style="text-align:left; font-family:monospace; background:#f1f5f9; padding:1rem; border-radius:4px; min-height:100px;"></div>
                            <div style="margin-top:1rem; font-size:0.8rem; color:#64748b;">
                                <strong>Indice:</strong> Essayez <code>' OR '1'='1</code> dans le champ password
                            </div>
                        </div>
                    </div>
                </div>
                ${getValidateButton('sqli')}
            `,
            
            'module-csrf': () => `
                ${getBackButton()}
                <h2 style="color:white; margin-bottom:1rem;">Lab 4: CSRF</h2>
                <div class="lab-container">
                    <div style="margin-bottom:0.5rem; color:#94a3b8;">Mission: Forger une requête pour changer l'email de l'admin.</div>
                    <div class="lab-browser">
                        <div class="browser-bar"><div class="url-bar">/account</div></div>
                        <div class="browser-content">
                            <h3>Changer l'Email</h3>
                            <div style="margin:1rem 0;">
                                <input type="email" id="csrf-email" class="vulnerable-input" placeholder="nouveau@email.com" value="hacker@evil.com">
                                <button onclick="submitCSRF()" class="vulnerable-btn">Changer Email</button>
                            </div>
                            <div id="csrf-result"></div>
                            <div style="margin-top:2rem; border-top:1px solid #cbd5e1; padding-top:1rem;">
                                <h4>Code malveillant à injecter:</h4>
                                <textarea style="width:100%; height:100px; font-family:monospace; font-size:0.8rem;" readonly>
<form action="https://victime.com/change-email" method="POST">
    <input type="hidden" name="email" value="hacker@evil.com">
</form>
<script>document.forms[0].submit();</script>
                                </textarea>
                            </div>
                        </div>
                    </div>
                </div>
                ${getValidateButton('csrf')}
            `,
            
            'module-xxe': () => `
                ${getBackButton()}
                <h2 style="color:white; margin-bottom:1rem;">Lab 5: XXE</h2>
                <div class="lab-container">
                    <div style="margin-bottom:0.5rem; color:#94a3b8;">Mission: Exfiltrer le fichier /etc/passwd via une injection XML.</div>
                    <div class="lab-browser">
                        <div class="browser-bar"><div class="url-bar">/upload</div></div>
                        <div class="browser-content">
                            <h3>Upload de fichier XML</h3>
                            <div style="margin:1rem 0;">
                                <textarea id="xxe-input" class="vulnerable-input" placeholder="XML content" style="width:100%; height:150px; font-family:monospace; font-size:0.8rem;" rows="6">
<?xml version="1.0"?>
<user>
    <name>John Doe</name>
    <email>john@example.com</email>
</user></textarea>
                                <button onclick="parseXXE()" class="vulnerable-btn" style="margin-top:0.5rem;">Parser XML</button>
                            </div>
                            <div id="xxe-result" class="xxe-output">
                                </div>
                            <div style="margin-top:1rem; font-size:0.8rem; color:#64748b;">
                                <strong>Indice:</strong> Essayez une entité externe: <code>&lt;!DOCTYPE foo [&lt;!ENTITY xxe SYSTEM "file:///etc/passwd"&gt;]&gt;</code>
                            </div>
                        </div>
                    </div>
                </div>
                ${getValidateButton('xxe')}
            `,
            
            'module-rc': () => `
                ${getBackButton()}
                <h2 style="color:white; margin-bottom:1rem;">Lab 6: Race Condition</h2>
                <div class="lab-container">
                    <div style="margin-bottom:0.5rem; color:#94a3b8;">Mission: Profiter d'une condition de course pour acheter plus de produits que le stock disponible.</div>
                    <div class="lab-browser">
                        <div class="browser-bar"><div class="url-bar">/shop</div></div>
                        <div class="browser-content">
                            <h3>Boutique en ligne</h3>
                            <div style="margin:1rem 0;">
                                <div style="background:#f0fdf4; padding:1rem; border-radius:4px;">
                                    <p><strong>Produit:</strong> Clé de licence premium</p>
                                    <p><strong>Prix:</strong> 100€</p>
                                    <p><strong>Stock:</strong> <span id="stock-count">${appState.raceStock}</span> unités</p>
                                    <p><strong>Votre argent:</strong> <span id="user-money">${appState.raceUserMoney}</span>€</p>
                                    <p><strong>Inventaire:</strong> <span id="user-inventory">${appState.raceInventory}</span></p>
                                </div>
                            </div>
                            
                            <div class="race-controls">
                                <button onclick="buyProduct()" class="vulnerable-btn">Acheter 1 unité</button>
                                <button onclick="startRaceCondition()" class="vulnerable-btn" style="background:#ef4444;">Lancer 10 requêtes simultanées</button>
                            </div>
                            
                            <div class="race-track" id="race-track">
                                <div class="race-progress" id="race-progress"></div>
                            </div>
                            
                            <div id="race-output" class="race-output">
                                </div>
                            
                            <div style="margin-top:1rem; font-size:0.8rem; color:#64748b;">
                                <strong>Indice:</strong> Envoyez plusieurs requêtes d'achat simultanées avant que le stock ne soit mis à jour
                            </div>
                        </div>
                    </div>
                </div>
                ${getValidateButton('rc')}
            `,
            
            'module-lfi': () => `
                ${getBackButton()}
                <h2 style="color:white; margin-bottom:1rem;">Lab 7: LFI</h2>
                <div class="lab-container">
                    <div style="margin-bottom:0.5rem; color:#94a3b8;">Mission: Lire le fichier /etc/passwd via une inclusion de fichier local.</div>
                    <div class="lab-browser">
                        <div class="browser-bar"><div class="url-bar">/view</div></div>
                        <div class="browser-content">
                            <h3>Vue de fichier</h3>
                            <div style="margin:1rem 0;">
                                <input type="text" id="lfi-input" class="vulnerable-input" placeholder="Nom du fichier" value="welcome.txt">
                                <button onclick="loadLFI()" class="vulnerable-btn">Afficher</button>
                            </div>
                            <div id="lfi-result" class="lfi-file-content">
                                </div>
                            <div style="margin-top:1rem; font-size:0.8rem; color:#64748b;">
                                <strong>Indice:</strong> Essayez des chemins comme <code>../../../etc/passwd</code> ou <code>../../../../etc/passwd</code>
                            </div>
                        </div>
                    </div>
                </div>
                ${getValidateButton('lfi')}
            `
        };

        // --- NAVIGATION ---
        function navigateTo(view) {
            appState.currentView = view;
            renderContent();
            updateNavButtons();
            updateXPBar();
            
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('mobile-open');
            }
        }

        function renderContent() {
            const contentArea = document.getElementById('content-area');
            const viewFunction = views[appState.currentView];
            
            if (viewFunction) {
                contentArea.innerHTML = viewFunction();
                // Initialize specific lab content if needed
                if (appState.currentView === 'module-idor') {
                    loadIDORProfile();
                } else if (appState.currentView === 'module-xxe') {
                   // Optional auto-run
                } else if (appState.currentView === 'module-lfi') {
                   // Optional auto-run
                }
            } else {
                contentArea.innerHTML = '<h2>Vue non trouvée</h2>';
            }
        }

        function renderNavButtons() {
            const navContainer = document.getElementById('nav-buttons');
            let html = '';
            
            // Dashboard button
            html += `<button class="nav-btn ${appState.currentView === 'dashboard' ? 'active' : ''}" onclick="navigateTo('dashboard')">
                        <i class="fa-solid fa-gauge"></i> Tableau de bord
                    </button>`;
            
            // Module buttons
            modulesData.forEach(module => {
                const isCompleted = appState.completedModules.includes(module.id);
                html += `<button class="nav-btn ${appState.currentView === 'module-' + module.id ? 'active' : ''}" onclick="navigateTo('module-${module.id}')">
                            <i class="fa-solid fa-${module.icon}" style="color:${module.color}"></i> ${module.title}
                            ${isCompleted ? '<span class="module-progress"><i class="fa-solid fa-check"></i></span>' : ''}
                        </button>`;
            });
            
            navContainer.innerHTML = html;
        }

        function updateNavButtons() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const activeBtn = document.querySelector(`.nav-btn[onclick*="navigateTo('${appState.currentView}')"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
        }

        // --- GESTION XP ET NIVEAUX ---
        function updateXPBar() {
            const xpPercentage = (appState.xp / 3000) * 100;
            document.getElementById('xp-bar').style.width = `${Math.min(xpPercentage, 100)}%`;
            
            // Mettre à jour le niveau
            if (appState.xp >= 3000) {
                appState.level = 5;
                document.getElementById('user-level').textContent = 'Expert';
            } else if (appState.xp >= 2000) {
                appState.level = 4;
                document.getElementById('user-level').textContent = 'Avancé';
            } else if (appState.xp >= 1000) {
                appState.level = 3;
                document.getElementById('user-level').textContent = 'Intermédiaire';
            } else if (appState.xp >= 500) {
                appState.level = 2;
                document.getElementById('user-level').textContent = 'Débutant';
            } else {
                appState.level = 1;
                document.getElementById('user-level').textContent = 'Novice';
            }
            
            document.getElementById('current-xp').textContent = `${appState.xp} XP`;
        }

        // --- VALIDATION MODULE ---
        function validateModule(moduleId) {
            if (!appState.completedModules.includes(moduleId)) {
                appState.completedModules.push(moduleId);
                const module = modulesData.find(m => m.id === moduleId);
                if (module) {
                    appState.xp += module.xp;
                    showToast(`+${module.xp} XP ! Module validé.`);
                }
                updateXPBar();
                renderNavButtons();
                renderContent(); // Refresh to disable button
            }
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- FONCTIONS DES LABS ---
        function showFakeAlert() {
            document.getElementById('fake-alert-overlay').style.display = 'flex';
        }

        function closeFakeAlert() {
            document.getElementById('fake-alert-overlay').style.display = 'none';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('mobile-open');
        }

        function runXSS() {
            const input = document.getElementById('xss-input').value;
            const resultDiv = document.getElementById('xss-result');
            
            if (input.includes('<script>alert(1)</script>') || input.includes('alert(1)')) {
                resultDiv.innerHTML = `Résultat de recherche pour: <strong>${escapeHtml(input)}</strong>`;
                showFakeAlert();
            } else {
                resultDiv.innerHTML = `Résultat de recherche pour: <strong>${escapeHtml(input)}</strong>`;
            }
        }

        function loadIDORProfile() {
            const profileId = document.getElementById('idor-input').value;
            const profileDiv = document.getElementById('idor-profile');
            
            if (profileId === '1234') {
                profileDiv.innerHTML = `
                    <h3>Profil Administrateur</h3>
                    <p><strong>ID:</strong> 1234</p>
                    <p><strong>Nom:</strong> Admin System</p>
                    <p><strong>Email:</strong> admin@bountyacademy.com</p>
                    <p><strong>Rôle:</strong> Super Administrateur</p>
                    <p><strong>Dernière connexion:</strong> 2024-01-15 14:30</p>
                    <p><strong>API Key:</strong> sk_live_123456789abcdef</p>
                    <p style="color:green; font-weight:bold;">✓ Accès administrateur obtenu!</p>
                `;
            } else {
                profileDiv.innerHTML = `
                    <h3>Profil Utilisateur</h3>
                    <p><strong>ID:</strong> ${profileId}</p>
                    <p><strong>Nom:</strong> Utilisateur ${profileId}</p>
                    <p><strong>Email:</strong> user${profileId}@example.com</p>
                    <p><strong>Rôle:</strong> Utilisateur standard</p>
                `;
            }
        }

        function runSQLI() {
            const username = document.getElementById('sqli-user').value;
            const password = document.getElementById('sqli-pass').value;
            const resultDiv = document.getElementById('sqli-result');
            
            if (password.includes("' OR '1'='1") || password.includes("' OR 1=1--")) {
                resultDiv.innerHTML = `
                    <p style="color:green;">✓ Connexion réussie!</p>
                    <p>Bienvenue, ${escapeHtml(username)}</p>
                    <p>Données extraites de la table users:</p>
                    <ul>
                        <li><strong>admin:admin123</strong> (Administrateur)</li>
                        <li>john:password123 (Utilisateur)</li>
                        <li>jane:qwerty (Utilisateur)</li>
                        <li>root:toor (Super Admin)</li>
                        <li>alice:alice123 (Modérateur)</li>
                    </ul>
                    <p style="color:green; font-weight:bold;">✓ SQL Injection réussie!</p>
                `;
            } else {
                resultDiv.innerHTML = `<p style="color:red;">✗ Échec de connexion - Identifiants incorrects</p>`;
            }
        }

        function submitCSRF() {
            const email = document.getElementById('csrf-email').value;
            const resultDiv = document.getElementById('csrf-result');
            
            resultDiv.innerHTML = `
                <div style="background:#f0fdf4; border:1px solid #bbf7d0; padding:1rem; border-radius:4px;">
                    <p style="color:#16a34a; margin:0;">
                        <i class="fa-solid fa-check"></i> Email changé avec succès!
                    </p>
                    <p style="margin-top:0.5rem; color:#334155;">
                        Nouvel email: <strong>${escapeHtml(email)}</strong>
                    </p>
                    <p style="font-size:0.8rem; color:#64748b;">
                        (Simulation CSRF réussie - l'email de l'admin a été changé)
                    </p>
                </div>
            `;
        }

        // --- Réparation de la fonction XXE coupée ---
        function parseXXE() {
            const xmlInput = document.getElementById('xxe-input').value;
            const resultDiv = document.getElementById('xxe-result');
            
            if (xmlInput.includes('<!ENTITY') && xmlInput.includes('SYSTEM') && xmlInput.includes('file://')) {
                resultDiv.innerHTML = `
                    <div class="xxe-success">✓ XXE Injection réussie!</div>
                    <div style="color:#334155; margin-top:1rem;">
                        <strong>Contenu de /etc/passwd:</strong>
                        <pre style="background:#f8fafc; padding:0.5rem; border-radius:4px; margin-top:0.5rem;">
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
                        </pre>
                    </div>
                `;
            } else {
                resultDiv.innerText = "Erreur de parsing XML: Entité invalide ou syntaxe incorrecte.";
            }
        }

        // --- FONCTIONS MANQUANTES (RACE CONDITION & LFI) ---
        function updateRaceUI() {
            const stockEl = document.getElementById('stock-count');
            const moneyEl = document.getElementById('user-money');
            const invEl = document.getElementById('user-inventory');
            if(stockEl) stockEl.innerText = appState.raceStock;
            if(moneyEl) moneyEl.innerText = appState.raceUserMoney;
            if(invEl) invEl.innerText = appState.raceInventory;
        }

        function buyProduct() {
            if (appState.raceStock > 0 && appState.raceUserMoney >= 100) {
                appState.raceStock--;
                appState.raceUserMoney -= 100;
                appState.raceInventory++;
                updateRaceUI();
                document.getElementById('race-output').innerHTML = '<span style="color:green">Achat réussi.</span>';
            } else {
                document.getElementById('race-output').innerHTML = '<span style="color:red">Stock épuisé ou fonds insuffisants.</span>';
            }
        }

        function startRaceCondition() {
            const output = document.getElementById('race-output');
            output.innerHTML = "Lancement de 10 requêtes simultanées...";
            const progressBar = document.getElementById('race-progress');
            progressBar.style.width = "0%";
            
            // Simulation de la faille
            // On envoie 10 requêtes, mais le check de stock est "lent"
            let successfulBuys = 0;
            let initialStock = appState.raceStock;
            
            // Simulation visuelle
            progressBar.style.width = "100%";
            
            setTimeout(() => {
                // Logique de faille: Si on lance 10 requêtes alors qu'il reste du stock
                // Le serveur mal codé pourrait valider plus d'achats que de stock
                
                if (initialStock > 0) {
                    // Exploit réussi : on achète plus que le stock (ex: 8 réussites sur 5 stocks)
                    successfulBuys = Math.min(10, initialStock + 3); 
                    
                    // Mise à jour de l'état buggé
                    appState.raceStock = 0; // Stock vide
                    appState.raceUserMoney -= (successfulBuys * 100);
                    appState.raceInventory += successfulBuys;
                    
                    updateRaceUI();
                    
                    output.innerHTML = `
                        <div style="background:#fee2e2; color:#b91c1c; padding:1rem; border-radius:4px;">
                            <strong>RACE CONDITION RÉUSSIE !</strong><br>
                            Requêtes envoyées: 10<br>
                            Stock initial: ${initialStock}<br>
                            Achats validés: ${successfulBuys}<br>
                            <br>
                            Le système a vendu plus d'objets qu'il n'en avait en stock car les requêtes sont arrivées avant la mise à jour de la base de données.
                        </div>
                    `;
                } else {
                    output.innerHTML = "Stock déjà à 0, impossible d'exploiter.";
                }
            }, 1000);
        }

        function loadLFI() {
            const input = document.getElementById('lfi-input').value;
            const result = document.getElementById('lfi-result');
            
            if (input === 'welcome.txt') {
                result.innerText = "Bienvenue sur notre serveur de fichiers sécurisé.";
            } else if (input.includes('../../../etc/passwd') || input.includes('..%2F..%2F..%2Fetc%2Fpasswd')) {
                result.innerHTML = `
<pre style="color:#334155;">
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
# ... fichier système lu avec succès
</pre>
<div style="color:green; font-weight:bold; margin-top:1rem;">✓ LFI Réussie !</div>
                `;
            } else {
                result.innerText = "Erreur: Fichier introuvable ou accès refusé.";
            }
        }

        // --- INITIALISATION DE L'APPLICATION ---
        // C'est la partie qui manquait pour afficher le contenu au démarrage
        renderNavButtons();
        updateXPBar();
        navigateTo('dashboard');

    </script>
</body>
</html>
