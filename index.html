<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BountyAcademy - Labs XSS, IDOR, SQLi, CSRF, XXE & Race Condition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; height: 100vh; overflow: hidden; }
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 16rem; background-color: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; z-index: 20; transition: transform 0.3s; }
        .sidebar-header { padding: 1.5rem; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid #334155; }
        .sidebar-header i { color: #10b981; font-size: 1.5rem; }
        .sidebar-header h1 { font-size: 1.25rem; font-weight: bold; color: white; }
        .sidebar-header span { color: #10b981; }
        .xp-panel { padding: 1rem; background-color: rgba(30, 41, 59, 0.5); margin: 1rem; border-radius: 0.5rem; border: 1px solid #475569; }
        .xp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .xp-label { font-size: 0.75rem; color: #94a3b8; font-weight: bold; text-transform: uppercase; }
        .user-level { font-size: 0.75rem; background-color: rgba(16, 185, 129, 0.2); color: #34d399; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
        .xp-bar-container { width: 100%; background-color: #334155; height: 0.5rem; border-radius: 9999px; overflow: hidden; }
        .xp-bar { background-color: #10b981; height: 100%; transition: width 0.5s; }
        .xp-info { display: flex; justify-content: space-between; margin-top: 0.25rem; font-size: 0.75rem; color: #94a3b8; }
        .nav-section { flex: 1; overflow-y: auto; padding: 0.5rem 0; }
        .nav-btn { width: 100%; text-align: left; padding: 0.75rem 1.5rem; color: #94a3b8; background: none; border: none; border-left: 4px solid transparent; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; transition: all 0.15s; }
        .nav-btn:hover, .nav-btn.active { color: #34d399; background-color: #1e293b; border-left-color: #10b981; }
        .nav-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .sidebar-footer { padding: 1rem; text-align: center; font-size: 0.75rem; color: #475569; border-top: 1px solid #334155; }
        .main-content { flex: 1; overflow-y: auto; background-color: #0f172a; position: relative; }
        .content-area { padding: 2rem; max-width: 64rem; margin: 0 auto; min-height: 100%; }
        .dashboard-title { font-size: 1.875rem; font-weight: bold; margin-bottom: 1.5rem; }
        .stat-card { background: rgba(30, 41, 59, 0.7); padding: 1.5rem; border-radius: 0.5rem; border: 1px solid rgba(255, 255, 255, 0.05); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 2rem; }
        .module-card { background-color: #1e293b; padding: 1rem; border-radius: 0.5rem; border: 1px solid #475569; margin-bottom: 1rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; }
        .module-card:hover { border-color: #10b981; transform: translateX(5px); }
        .action-btn { width: 100%; padding: 1rem; background-color: #059669; color: white; border: none; border-radius: 0.5rem; cursor: pointer; margin-top: 1rem; font-size: 1rem; transition: background 0.2s; }
        .action-btn:hover { background-color: #047857; }
        .action-btn:disabled { background-color: #334155; cursor: not-allowed; }
        .back-btn { background:none; border:none; color: #94a3b8; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem; font-size: 1rem; }
        .back-btn:hover { color: #10b981; }
        
        /* Labs Containers */
        .lab-container { background-color: #1e293b; border: 1px solid #475569; border-radius: 0.5rem; padding: 1.5rem; margin-top: 1rem; }
        .lab-browser { background-color: #f8fafc; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); color: #334155; font-family: 'Segoe UI', sans-serif; border: 1px solid #cbd5e1; }
        .browser-bar { background-color: #e2e8f0; padding: 0.5rem 1rem; display: flex; align-items: center; gap: 0.5rem; border-bottom: 1px solid #cbd5e1; }
        .browser-dots { display: flex; gap: 0.25rem; }
        .dot { width: 0.75rem; height: 0.75rem; border-radius: 50%; }
        .dot-red { background-color: #ef4444; }
        .dot-yellow { background-color: #f59e0b; }
        .dot-green { background-color: #10b981; }
        .url-bar { background-color: white; padding: 0.25rem 0.75rem; border-radius: 0.25rem; flex: 1; font-size: 0.8rem; color: #64748b; margin-left: 1rem; border: 1px solid #cbd5e1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .browser-content { padding: 2rem; min-height: 250px; text-align: center; position: relative; }
        
        /* Inputs & Buttons Labs */
        .vulnerable-input { padding: 0.75rem; border: 2px solid #cbd5e1; border-radius: 0.25rem; width: 70%; margin-right: 0.5rem; font-size: 1rem; outline: none; }
        .vulnerable-input:focus { border-color: #3b82f6; }
        .vulnerable-btn { padding: 0.75rem 1.5rem; background-color: #3b82f6; color: white; border: none; border-radius: 0.25rem; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
        .vulnerable-btn:hover { background-color: #2563eb; }
        .search-result { margin-top: 2rem; padding: 1rem; border: 1px dashed #94a3b8; background-color: #f1f5f9; border-radius: 0.25rem; display: none; text-align: left; max-width: 80%; margin-left: auto; margin-right: auto; }
        
        /* IDOR Styles */
        .profile-card { border: 1px solid #cbd5e1; border-radius: 8px; padding: 20px; max-width: 400px; margin: 0 auto; background: white; text-align: left; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .profile-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px; }
        .profile-avatar { width: 60px; height: 60px; background: #e2e8f0; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #64748b; }
        .profile-details p { margin-bottom: 8px; font-size: 0.9rem; }
        .profile-label { font-weight: bold; color: #475569; width: 80px; display: inline-block; }
        .api-key { background: #fee2e2; color: #991b1b; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 0.85rem; }
        .idor-control { margin-top: 20px; padding: 15px; background: #f1f5f9; border-radius: 8px; display: inline-flex; align-items: center; gap: 10px; }
        
        /* SQLi/CSRF Styles */
        .login-box { max-width: 350px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .login-input { width: 100%; padding: 10px; margin-bottom: 1rem; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 1rem; }
        .sql-debug { margin-top: 20px; font-family: monospace; font-size: 0.85rem; background: #1e293b; color: #10b981; padding: 10px; border-radius: 4px; text-align: left; border-left: 3px solid #10b981; min-height: 3.5em; display: flex; align-items: center; }

        /* CSRF Styles */
        .csrf-panel { max-width: 500px; margin: 0 auto; }
        .csrf-target { background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid #e2e8f0; text-align: left; color: #334155; }
        .csrf-attacker { background: #fee2e2; padding: 1rem; border-radius: 8px; border: 1px solid #fca5a5; margin-top: 1rem; text-align: left; color: #991b1b; }
        .csrf-payload { width: 100%; height: 80px; font-family: monospace; font-size: 0.85rem; padding: 5px; border: 1px solid #fca5a5; margin-top: 0.5rem; resize: vertical; }
        
        /* XXE Styles */
        .xxe-input { width: 100%; height: 150px; font-family: monospace; font-size: 0.9rem; padding: 10px; border: 1px solid #cbd5e1; border-radius: 4px; resize: vertical; }
        .xxe-output { margin-top: 1.5rem; padding: 1rem; border: 1px solid #e2e8f0; background: #f1f5f9; border-radius: 4px; text-align: left; min-height: 100px; color: #334155; overflow: auto; }
        .xxe-error { color:#ef4444; font-weight:bold; }
        .xxe-success { color:#10b981; font-weight:bold; }

        /* --- Styles for Race Condition Lab (LAB 6) --- */
        .shop-mission-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1rem 0;
        }
        .shop-product-card {
            background: #1e293b;
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid #334155;
            max-width: 400px;
            margin: 0 auto 2rem;
        }
        .shop-product-image {
            width: 100%;
            height: 150px;
            background: linear-gradient(45deg, #334155, #475569);
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: #94a3b8;
        }
        .shop-product-price {
            color: #10b981;
            font-size: 2rem;
            font-weight: bold;
            margin: 1rem 0;
        }
        .shop-cart-summary {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 2rem auto;
            max-width: 500px;
            text-align: center;
        }
        .shop-cart-value {
            font-size: 2rem;
            font-weight: bold;
            color: #fbbf24;
            margin: 0.5rem 0;
        }
        .shop-amount-paid {
            font-size: 2rem;
            font-weight: bold;
            color: #10b981;
            margin: 0.5rem 0;
        }
        .shop-savings {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ef4444;
            margin: 0.5rem 0;
        }
        .shop-attack-panel {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid #ef4444;
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        .shop-logs {
            background: #0f172a;
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 2rem;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        .shop-products-received {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
            flex-wrap: wrap;
        }
        .shop-product-received {
            background: #334155;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            min-width: 80px;
            border: 2px solid #475569;
        }
        .shop-product-free {
            border-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }
        /* Fin des styles Race Condition */


        /* Feedback Elements */
        .fake-alert-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(2px); }
        .fake-alert-box { background: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); width: 320px; text-align: center; color: #0f172a; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .alert-btn { margin-top: 1rem; background: #3b82f6; color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 0.25rem; cursor: pointer; }
        .toast { position: fixed; bottom: 20px; right: 20px; background: #1e293b; border-left: 4px solid #10b981; color: white; padding: 15px 20px; border-radius: 4px; transform: translateX(150%); transition: transform 0.3s; z-index: 100; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3); display: flex; align-items: center; gap: 10px; }
        .toast.show { transform: translateX(0); }
        
        .mobile-header { display: none; }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .sidebar { position: fixed; transform: translateX(-100%); height: 100vh; }
            .sidebar.mobile-open { transform: translateX(0); }
            .mobile-header { display: flex; padding: 1rem; background: #1e293b; justify-content: space-between; align-items: center; border-bottom: 1px solid #334155; }
            .mobile-menu-btn { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }
            .vulnerable-input { width: 100%; margin-bottom: 0.5rem; }
            .vulnerable-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <i class="fa-solid fa-bug"></i>
                <h1>Bounty<span>Acad</span></h1>
            </div>
            <div class="xp-panel">
                <div class="xp-header">
                    <span class="xp-label">Rang</span>
                    <span id="user-level" class="user-level">Novice</span>
                </div>
                <div class="xp-bar-container">
                    <div id="xp-bar" class="xp-bar" style="width: 0%"></div>
                </div>
                <div class="xp-info">
                    <span id="current-xp">0 XP</span>
                    <span id="next-level-xp">2400 XP (Max)</span>
                </div>
            </div>
            <div class="nav-section">
                <button class="nav-btn active" onclick="navigateTo('dashboard')" data-view="dashboard">
                    <i class="fa-solid fa-chart-line"></i> Dashboard
                </button>
                <div style="padding: 1rem; font-size: 0.75rem; color: #64748b; font-weight: bold;">MODULES PRATIQUES</div>
                <button class="nav-btn" onclick="navigateTo('module-xss')" data-view="module-xss">
                    <i class="fa-solid fa-code"></i> Lab 1: XSS Reflected
                </button>
                <button class="nav-btn" onclick="navigateTo('module-idor')" data-view="module-idor">
                    <i class="fa-solid fa-id-card"></i> Lab 2: IDOR
                </button>
                <button class="nav-btn" onclick="navigateTo('module-sqli')" data-view="module-sqli">
                    <i class="fa-solid fa-database"></i> Lab 3: SQL Injection
                </button>
                <button class="nav-btn" onclick="navigateTo('module-csrf')" data-view="module-csrf">
                    <i class="fa-solid fa-hand-pointer"></i> Lab 4: CSRF
                </button>
                 <button class="nav-btn" onclick="navigateTo('module-xxe')" data-view="module-xxe">
                    <i class="fa-solid fa-file-code"></i> Lab 5: XXE
                </button>
                <button class="nav-btn" onclick="navigateTo('module-race-condition')" data-view="module-race-condition">
                    <i class="fa-solid fa-gauge-high"></i> Lab 6: Race Condition
                </button>
            </div>
            <div class="sidebar-footer">v1.7 | Race Condition Added</div>
        </nav>

        <main class="main-content">
            <div class="mobile-header">
                <span style="font-weight: bold; color:white;">BountyAcademy</span>
                <button class="mobile-menu-btn" onclick="document.getElementById('sidebar').classList.toggle('mobile-open')">
                    <i class="fa-solid fa-bars"></i>
                </button>
            </div>
            <div id="content-area" class="content-area"></div>
        </main>
    </div>

    <div id="toast" class="toast">
        <i class="fa-solid fa-check-circle" style="color:#34d399"></i> <span id="toast-message">Succès !</span>
    </div>

    <div id="fake-alert-overlay" class="fake-alert-overlay">
        <div class="fake-alert-box">
            <h3 style="margin-bottom: 0.5rem; color: #ef4444; display:flex; align-items:center; justify-content:center; gap:0.5rem;">
                <i class="fa-solid fa-triangle-exclamation"></i> Alert
            </h3>
            <p style="margin-bottom: 1rem; color:#334155;">Le site indique :</p>
            <p id="alert-content" style="font-family: monospace; font-size:1.2rem; font-weight:bold; background: #f1f5f9; padding: 0.5rem; margin-bottom: 1rem; border-radius: 4px; border:1px solid #cbd5e1;">1</p>
            <button class="alert-btn" onclick="closeFakeAlert()">OK</button>
        </div>
    </div>

    <script>
        var appState = {
            xp: 0,
            level: 1,
            completedModules: [],
            currentView: 'dashboard'
        };

        var modules = {
            dashboard: {
                render: function() {
                    var html = '';
                    html += '<h2 class="dashboard-title">Tableau de bord</h2>';
                    html += '<div class="stats-grid">';
                    html += '<div class="stat-card">';
                    html += '<div style="color: #94a3b8; font-size: 0.875rem;">XP Total</div>';
                    html += '<div style="font-size: 1.875rem; font-weight: bold; color: white;">' + appState.xp + '</div>';
                    html += '</div>';
                    html += '<div class="stat-card">';
                    html += '<div style="color: #94a3b8; font-size: 0.875rem;">Modules Terminés</div>';
                    html += '<div style="font-size: 1.875rem; font-weight: bold; color: white;">' + appState.completedModules.length + '/6</div>';
                    html += '</div>';
                    html += '</div>';
                    html += '<h3 style="color:white; margin-bottom:1rem;">Continuer l\'apprentissage</h3>';
                    
                    // CARTE XSS
                    html += '<div class="module-card" onclick="navigateTo(\'module-xss\')">';
                    html += '<div style="display:flex; align-items:center; gap:1rem;">';
                    html += '<div style="width: 3rem; height: 3rem; background: #334155; border-radius: 50%; display:flex; align-items:center; justify-content:center; color: #10b981;">';
                    html += '<i class="fa-solid fa-code"></i>';
                    html += '</div>';
                    html += '<div>';
                    html += '<h4 style="color: white; font-weight: bold;">Lab 1: XSS Reflected</h4>';
                    html += '<p style="font-size: 0.75rem; color: #94a3b8;">Niveau: Facile • 200 XP</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<i class="fa-solid fa-chevron-right" style="color: #475569;"></i>';
                    html += '</div>';
                    
                    // CARTE IDOR
                    html += '<div class="module-card" onclick="navigateTo(\'module-idor\')">';
                    html += '<div style="display:flex; align-items:center; gap:1rem;">';
                    html += '<div style="width: 3rem; height: 3rem; background: #334155; border-radius: 50%; display:flex; align-items:center; justify-content:center; color: #f59e0b;">';
                    html += '<i class="fa-solid fa-id-card"></i>';
                    html += '</div>';
                    html += '<div>';
                    html += '<h4 style="color: white; font-weight: bold;">Lab 2: IDOR</h4>';
                    html += '<p style="font-size: 0.75rem; color: #94a3b8;">Niveau: Moyen • 300 XP</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<i class="fa-solid fa-chevron-right" style="color: #475569;"></i>';
                    html += '</div>';

                    // CARTE SQLI
                    html += '<div class="module-card" onclick="navigateTo(\'module-sqli\')">';
                    html += '<div style="display:flex; align-items:center; gap:1rem;">';
                    html += '<div style="width: 3rem; height: 3rem; background: #334155; border-radius: 50%; display:flex; align-items:center; justify-content:center; color: #ef4444;">';
                    html += '<i class="fa-solid fa-database"></i>';
                    html += '</div>';
                    html += '<div>';
                    html += '<h4 style="color: white; font-weight: bold;">Lab 3: SQL Injection</h4>';
                    html += '<p style="font-size: 0.75rem; color: #94a3b8;">Niveau: Intermédiaire • 400 XP</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<i class="fa-solid fa-chevron-right" style="color: #475569;"></i>';
                    html += '</div>';

                    // CARTE CSRF
                    html += '<div class="module-card" onclick="navigateTo(\'module-csrf\')">';
                    html += '<div style="display:flex; align-items:center; gap:1rem;">';
                    html += '<div style="width: 3rem; height: 3rem; background: #334155; border-radius: 50%; display:flex; align-items:center; justify-content:center; color: #3b82f6;">';
                    html += '<i class="fa-solid fa-hand-pointer"></i>';
                    html += '</div>';
                    html += '<div>';
                    html += '<h4 style="color: white; font-weight: bold;">Lab 4: CSRF (Request Forgery)</h4>';
                    html += '<p style="font-size: 0.75rem; color: #94a3b8;">Niveau: Avancé • 400 XP</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<i class="fa-solid fa-chevron-right" style="color: #475569;"></i>';
                    html += '</div>';
                    
                    // CARTE XXE
                    html += '<div class="module-card" onclick="navigateTo(\'module-xxe\')">';
                    html += '<div style="display:flex; align-items:center; gap:1rem;">';
                    html += '<div style="width: 3rem; height: 3rem; background: #334155; border-radius: 50%; display:flex; align-items:center; justify-content:center; color: #fbbf24;">';
                    html += '<i class="fa-solid fa-file-code"></i>';
                    html += '</div>';
                    html += '<div>';
                    html += '<h4 style="color: white; font-weight: bold;">Lab 5: XXE (External Entity)</h4>';
                    html += '<p style="font-size: 0.75rem; color: #94a3b8;">Niveau: Expert • 500 XP</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<i class="fa-solid fa-chevron-right" style="color: #475569;"></i>';
                    html += '</div>';

                    // CARTE RACE CONDITION (NEW)
                    html += '<div class="module-card" onclick="navigateTo(\'module-race-condition\')">';
                    html += '<div style="display:flex; align-items:center; gap:1rem;">';
                    html += '<div style="width: 3rem; height: 3rem; background: #334155; border-radius: 50%; display:flex; align-items:center; justify-content:center; color: #ef4444;">';
                    html += '<i class="fa-solid fa-gauge-high"></i>';
                    html += '</div>';
                    html += '<div>';
                    html += '<h4 style="color: white; font-weight: bold;">Lab 6: Race Condition</h4>';
                    html += '<p style="font-size: 0.75rem; color: #94a3b8;">Niveau: Expert+ • 600 XP</p>';
                    html += '</div>';
                    html += '</div>';
                    html += '<i class="fa-solid fa-chevron-right" style="color: #475569;"></i>';
                    html += '</div>';

                    return html;
                }
            },
            'module-xss': {
                xpReward: 200,
                render: function() {
                    var isDone = appState.completedModules.indexOf('module-xss') !== -1;
                    var html = '';
                    html += '<button onclick="navigateTo(\'dashboard\')" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Retour</button>';
                    html += '<h2 class="dashboard-title"><i class="fa-solid fa-code" style="color:#10b981"></i> Lab 1: XSS Reflected</h2>';
                    html += '<div class="stat-card" style="margin-bottom: 2rem;">';
                    html += '<h3 style="color: white; margin-bottom: 0.5rem;">Mission : Hackez cette recherche</h3>';
                    html += '<p style="color: #cbd5e1; line-height: 1.6;">Injectez du code JavaScript pour faire apparaître une <code>alert(1)</code>.</p>';
                    html += '</div>';
                    html += '<div class="lab-container">';
                    html += '<div style="margin-bottom: 1rem; color: #cbd5e1;">http://vulnerable-search.com</div>';
                    html += '<div class="lab-browser"><div class="browser-bar"><div class="browser-dots"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div><div class="url-bar">/search</div></div>';
                    html += '<div class="browser-content"><h2 style="margin-bottom: 1.5rem; color: #1e293b;">Super Search</h2>';
                    html += '<div style="display: flex; justify-content: center; gap:0.5rem;"><input type="text" id="lab-input" class="vulnerable-input" placeholder="Que cherchez-vous ?"><button onclick="runXSSLab()" class="vulnerable-btn">Go</button></div>';
                    html += '<div id="lab-result" class="search-result"></div></div></div></div>';
                    html += '<button id="validate-btn" class="action-btn" disabled>' + (isDone ? 'Validé' : 'À faire') + '</button>';
                    return html;
                }
            },
            'module-idor': {
                xpReward: 300,
                render: function() {
                    var isDone = appState.completedModules.indexOf('module-idor') !== -1;
                    var html = '';
                    html += '<button onclick="navigateTo(\'dashboard\')" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Retour</button>';
                    html += '<h2 class="dashboard-title"><i class="fa-solid fa-id-card" style="color:#f59e0b"></i> Lab 2: IDOR</h2>';
                    html += '<div class="stat-card" style="margin-bottom: 2rem;">';
                    html += '<h3 style="color: white; margin-bottom: 0.5rem;">Mission : Accès Admin</h3>';
                    html += '<p style="color: #cbd5e1; line-height: 1.6;">Vous êtes ID 101 (Invité). Trouvez le profil Admin (ID 100).</p>';
                    html += '</div>';
                    html += '<div class="lab-container"><div style="margin-bottom: 1rem; color: #cbd5e1;">http://internal-api.local</div>';
                    html += '<div class="lab-browser"><div class="browser-bar"><div class="browser-dots"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div><div id="idor-url-bar" class="url-bar">/profile?id=101</div></div>';
                    html += '<div class="browser-content" style="background:#f8fafc;"><div id="idor-result"><div class="profile-card"><div class="profile-header"><div class="profile-avatar"><i class="fa-solid fa-user"></i></div><div><h3>Invité</h3><span style="color:#64748b; font-size:0.8rem;">Utilisateur Standard</span></div></div><div class="profile-details"><p><span class="profile-label">User ID:</span> 101</p></div></div></div>';
                    html += '<div class="idor-control"><label style="color:#334155;">ID:</label><input type="number" id="idor-input" class="vulnerable-input" style="width:80px;" value="101"><button onclick="runIDORLab()" class="vulnerable-btn">Charger</button></div></div></div></div>';
                    html += '<button id="validate-btn-idor" class="action-btn" disabled>' + (isDone ? 'Validé' : 'À faire') + '</button>';
                    return html;
                }
            },
            'module-sqli': {
                xpReward: 400,
                render: function() {
                    var isDone = appState.completedModules.indexOf('module-sqli') !== -1;
                    var html = '';
                    html += '<button onclick="navigateTo(\'dashboard\')" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Retour</button>';
                    html += '<h2 class="dashboard-title"><i class="fa-solid fa-database" style="color:#ef4444"></i> Lab 3: SQL Injection</h2>';
                    
                    html += '<div class="stat-card" style="margin-bottom: 2rem;">';
                    html += '<h3 style="color: white; margin-bottom: 0.5rem;">Mission : Bypass Login</h3>';
                    html += '<p style="color: #cbd5e1; line-height: 1.6;">';
                    html += 'Connectez-vous en tant qu\'administrateur sans connaître le mot de passe. ';
                    html += 'Utilisez une injection SQL pour forcer la condition de connexion à être toujours VRAIE.';
                    html += '<br><br><strong>Payload suggérée :</strong> <code>\' OR \'1\'=\'1</code>';
                    html += '</p>';
                    html += '</div>';

                    html += '<div class="lab-container">';
                    html += '<div style="margin-bottom: 1rem; color: #cbd5e1;">http://bank-admin.local/login</div>';
                    html += '<div class="lab-browser">';
                    html += '<div class="browser-bar"><div class="browser-dots"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div><div class="url-bar">/login.php</div></div>';
                    
                    // Contenu du Browser (Formulaire Login)
                    html += '<div class="browser-content" style="background:#f1f5f9; display:flex; flex-direction:column; align-items:center;">';
                    
                    html += '<div id="sqli-view">'; // Vue changeable (Form ou Dashboard Admin)
                    html += '<div class="login-box">';
                    html += '<h3 style="color:#1e293b; margin-bottom:1.5rem;">Admin Panel Login</h3>';
                    html += '<input type="text" id="sqli-user" class="login-input" placeholder="Username">';
                    html += '<input type="password" id="sqli-pass" class="login-input" placeholder="Password">';
                    html += '<button onclick="runSQLiLab()" class="vulnerable-btn" style="width:100%;">Se Connecter</button>';
                    html += '<div id="sqli-error" style="color:#ef4444; margin-top:10px; font-size:0.9rem; display:none;">Identifiants invalides</div>';
                    html += '</div>';
                    html += '</div>'; // fin sqli-view
                    
                    html += '</div>'; // fin browser-content
                    html += '<div id="sqli-debug" class="sql-debug">En attente d\'exécution...</div>';
                    html += '</div></div>'; // fin lab-container & browser

                    html += '<button id="validate-btn-sqli" class="action-btn" disabled>';
                    html += isDone ? '<i class="fa-solid fa-check"></i> Module Déjà Validé' : 'Bypassez le login pour valider';
                    html += '</button>';
                    
                    return html;
                }
            },
            'module-csrf': {
                xpReward: 400,
                render: function() {
                    var isDone = appState.completedModules.indexOf('module-csrf') !== -1;
                    var html = '';
                    html += '<button onclick="navigateTo(\'dashboard\')" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Retour</button>';
                    html += '<h2 class="dashboard-title"><i class="fa-solid fa-hand-pointer" style="color:#3b82f6"></i> Lab 4: CSRF (Cross-Site Request Forgery)</h2>';
                    
                    html += '<div class="stat-card" style="margin-bottom: 2rem;">';
                    html += '<h3 style="color: white; margin-bottom: 0.5rem;">Mission : Changer l\'email de l\'utilisateur</h3>';
                    html += '<p style="color: #cbd5e1; line-height: 1.6;">';
                    html += 'La page "Settings" permet de changer l\'email via une simple requête GET. ';
                    html += 'Créez une payload sur la page de l\'attaquant pour déclencher cette action.';
                    html += '<br><br><strong>Action de la victime :</strong> <code>/settings/update?email=...</code>';
                    html += '</p>';
                    html += '</div>';

                    html += '<div class="lab-container">';
                    html += '<div class="csrf-panel">';
                    
                    // Partie 1: Site de la Victime (simulé)
                    html += '<h4 style="color:white; margin-bottom:0.5rem;"><i class="fa-solid fa-lock"></i> Site de la Victime (Connecté)</h4>';
                    html += '<div class="csrf-target">';
                    html += '<h3>Mes Paramètres</h3>';
                    html += '<p style="font-size: 0.9rem;">E-mail actuel: <strong id="csrf-victim-email">user@victim.com</strong></p>';
                    html += '<p style="margin-top: 10px; font-size: 0.8rem; color: #64748b;">(Cliquez ici pour simuler un changement d\'email par l\'utilisateur lui-même.)</p>';
                    html += '<button onclick="simulerChangementEmail(false)" class="vulnerable-btn" style="background:#10b981; margin-top:0.5rem;">Changer mon E-mail</button>';
                    html += '</div>';
                    
                    // Partie 2: Site de l'Attaquant (où l'utilisateur colle sa payload)
                    html += '<h4 style="color:white; margin-top:1.5rem; margin-bottom:0.5rem;"><i class="fa-solid fa-skull"></i> Site de l\'Attaquant (External)</h4>';
                    html += '<div class="csrf-attacker">';
                    html += '<h3>Générateur de Payload CSRF</h3>';
                    html += '<p style="font-size: 0.9rem;">Collez le code HTML pour changer l\'email de l\'utilisateur connecté.</p>';
                    html += '<textarea id="csrf-payload-input" class="csrf-payload" placeholder="Ex: <img src=\'...\'> ou <iframe src=\'...\'>"></textarea>';
                    html += '<button onclick="runCSRFLab()" class="vulnerable-btn" style="background:#ef4444; width:100%;">Déclencher l\'Attaque (Simuler le clic)</button>';
                    html += '<p id="csrf-output" style="margin-top: 10px; font-size: 0.85rem; color: #64748b; font-style:italic;">En attente de la payload...</p>';
                    html += '</div>';
                    
                    html += '</div>'; // fin csrf-panel
                    html += '</div>'; // fin lab-container

                    html += '<button id="validate-btn-csrf" class="action-btn" disabled>';
                    html += isDone ? '<i class="fa-solid fa-check"></i> Module Déjà Validé' : 'L\'attaque doit réussir pour valider';
                    html += '</button>';
                    
                    return html;
                }
            },
            'module-xxe': { // NOUVEAU MODULE XXE
                xpReward: 500,
                render: function() {
                    var isDone = appState.completedModules.indexOf('module-xxe') !== -1;
                    var html = '';
                    html += '<button onclick="navigateTo(\'dashboard\')" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Retour</button>';
                    html += '<h2 class="dashboard-title"><i class="fa-solid fa-file-code" style="color:#fbbf24"></i> Lab 5: XXE (XML External Entity)</h2>';
                    
                    html += '<div class="stat-card" style="margin-bottom: 2rem;">';
                    html += '<h3 style="color: white; margin-bottom: 0.5rem;">Mission : Exfiltration de fichier</h3>';
                    html += '<p style="color: #cbd5e1; line-height: 1.6;">';
                    html += 'Ce service de configuration XML est vulnérable aux entités externes. Exfiltrez le contenu du fichier système <code>/etc/passwd</code>.';
                    html += '<br><br><strong>Chemin cible :</strong> <code>file:///etc/passwd</code>';
                    html += '</p>';
                    html += '</div>';

                    html += '<div class="lab-container">';
                    html += '<div style="margin-bottom: 1rem; color: #cbd5e1;">http://api.config-uploader.local/process</div>';
                    html += '<div class="lab-browser">';
                    html += '<div class="browser-bar"><div class="browser-dots"><div class="dot dot-red"></div><div class="dot dot-yellow"></div><div class="dot dot-green"></div></div><div class="url-bar">/upload-xml</div></div>';
                    
                    html += '<div class="browser-content" style="background:#f1f5f9; display:flex; flex-direction:column; align-items:center;">';
                    html += '<h3 style="color:#1e293b; margin-bottom:1.5rem;">Uploader de Fichier de Configuration XML</h3>';
                    html += '<textarea id="xxe-input" class="xxe-input" placeholder="Collez votre document XML ici (ex: <config><setting>value</setting></config>)."></textarea>';
                    html += '<button onclick="runXXELab()" class="vulnerable-btn" style="width:100%;">Envoyer le XML</button>';
                    
                    html += '<div id="xxe-output" class="xxe-output">Résultat du traitement XML...</div>';
                    
                    html += '</div>'; // fin browser-content
                    html += '</div></div>'; // fin lab-container & browser

                    html += '<button id="validate-btn-xxe" class="action-btn" disabled>';
                    html += isDone ? '<i class="fa-solid fa-check"></i> Module Déjà Validé' : 'Affichez le contenu de /etc/passwd pour valider';
                    html += '</button>';
                    
                    return html;
                }
            },
            'module-race-condition': {
                xpReward: 600,
                render: function() {
                    var isDone = appState.completedModules.indexOf('module-race-condition') !== -1;
                    var html = '';
                    html += '<button onclick="navigateTo(\'dashboard\')" class="back-btn"><i class="fa-solid fa-arrow-left"></i> Retour</button>';
                    html += '<h2 class="dashboard-title"><i class="fa-solid fa-gauge-high" style="color:#ef4444"></i> Lab 6: Race Condition</h2>';
                    
                    html += '<div class="shop-mission-box" style="margin-bottom: 2rem;">';
                    html += '<h3 style="color: white; margin-bottom: 0.5rem;"><i class="fa-solid fa-bullseye"></i> Mission d\'Attaque</h3>';
                    html += '<p style="color: #cbd5e1; line-height: 1.6;"><strong>Objectif :</strong> Avoir 4 produits dans le panier (120€) mais ne payer que 90€.</p>';
                    html += '<p style="color: #cbd5e1; line-height: 1.6;"><strong>Technique :</strong> Soumettre des transactions concurrentes pour exploiter le délai entre la lecture du solde et son écriture.</p>';
                    html += '</div>';

                    html += '<div class="shop-cart-summary">';
                    html += '<h3><i class="fa-solid fa-receipt"></i> Récapitulatif de Commande</h3>';
                    html += '<div>Valeur du panier: <span class="shop-cart-value" id="rc-cart-value">0.00 €</span></div>';
                    html += '<div>Montant payé: <span class="shop-amount-paid" id="rc-amount-paid">0.00 €</span></div>';
                    html += '<div>Économie: <span class="shop-savings" id="rc-savings">0.00 €</span></div>';
                    html += '</div>';

                    html += '<div class="product-section">';
                    html += '<h2><i class="fa-solid fa-star"></i> Produit Unique</h2>';
                    
                    html += '<div class="shop-product-card">';
                    html += '<div class="shop-product-image">';
                    html += '<i class="fas fa-gamepad"></i>';
                    html += '</div>';
                    html += '<h3>Manette Gaming Elite</h3>';
                    html += '<div class="shop-product-price">30.00 €</div>';
                    html += '<p>Manette professionnelle avec retour haptique</p>';
                    html += '<p>Solde initial: 90.00 € • Limite: 4 produits</p>';
                    html += '<button class="btn btn-primary" onclick="rcBuyProduct()" id="rc-buy-btn">';
                    html += '<i class="fa-solid fa-cart-plus"></i> Acheter Maintenant - 30.00 €';
                    html += '</button>';
                    html += '</div>';
                    
                    html += '<div class="exploit-info">';
                    html += '<h4><i class="fa-solid fa-lightbulb"></i> Panneau d\'Attaque</h4>';
                    html += '<p>Simulez une attaque par race condition avec précision.</p>';
                    html += '</div>';
                    html += '</div>';

                    html += '<div class="shop-products-received" id="rc-products-received">';
                    html += '';
                    html += '</div>';
                    
                    html += '<div class="shop-attack-panel">';
                    html += '<h2><i class="fa-solid fa-bomb"></i> Lanceur d\'Attaque</h2>';
                    html += '<p>Soumet 3 requêtes d\'achat quasi-simultanément.</p>';
                    
                    html += '<div class="attack-controls">';
                    html += '<button class="btn btn-danger" onclick="rcStartRapidAttack(3)" id="rc-attack-3-btn">';
                    html += '<i class="fa-solid fa-bolt"></i> Attaque Rapide (3 requêtes)';
                    html += '</button>';
                    html += '<button class="btn btn-primary" onclick="rcResetShop()">';
                    html += '<i class="fa-solid fa-rotate"></i> Réinitialiser la Boutique';
                    html += '</button>';
                    html += '</div>';
                    html += '</div>';
                    
                    html += '<div class="shop-logs">';
                    html += '<h3><i class="fa-solid fa-list"></i> Journal des Transactions</h3>';
                    html += '<div id="rc-transaction-logs">';
                    html += '<div class="log-entry log-info">[Système] Bienvenue! Solde initial: 90.00 €</div>';
                    html += '</div>';
                    html += '</div>';

                    html += '<button id="validate-btn-rc" class="action-btn" disabled>';
                    html += isDone ? '<i class="fa-solid fa-check"></i> Module Déjà Validé' : 'Achetez 4 produits en payant 90€ pour valider';
                    html += '</button>';
                    
                    // Initialization script for this module
                    html += '<script>rcInit();</script>';

                    return html;
                }
            }
        };

        function init() {
            try {
                // IMPORTANT: Mise à jour de la clé de sessionStorage pour éviter les conflits XP
                var saved = sessionStorage.getItem('bountyState_v7'); // Clé mise à jour pour la version 1.7
                if (saved) {
                    var parsed = JSON.parse(saved);
                    appState.xp = parsed.xp || 0;
                    appState.completedModules = parsed.completedModules || [];
                }
            } catch(e) {}
            updateUI();
            navigateTo('dashboard');
        }

        function saveState() {
            try { sessionStorage.setItem('bountyState_v7', JSON.stringify(appState)); } catch(e) {}
        }

        function navigateTo(viewName) {
            appState.currentView = viewName;
            var contentArea = document.getElementById('content-area');
            
            var buttons = document.querySelectorAll('.nav-btn');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].classList.remove('active');
                if (buttons[i].getAttribute('data-view') === viewName) {
                    buttons[i].classList.add('active');
                }
            }

            if (modules[viewName]) {
                contentArea.innerHTML = modules[viewName].render();
                
                // Event Listeners (Entrée Clavier)
                setTimeout(function() {
                    if (viewName === 'module-xss') {
                        var input = document.getElementById('lab-input');
                        if(input) input.addEventListener('keypress', function(e) { if(e.key === 'Enter') runXSSLab(); });
                    } else if (viewName === 'module-idor') {
                        var input = document.getElementById('idor-input');
                        if(input) input.addEventListener('keypress', function(e) { if(e.key === 'Enter') runIDORLab(); });
                    } else if (viewName === 'module-sqli') {
                        var inputUser = document.getElementById('sqli-user');
                        var inputPass = document.getElementById('sqli-pass');
                        var fn = function(e) { if(e.key === 'Enter') runSQLiLab(); };
                        if(inputUser) inputUser.addEventListener('keypress', fn);
                        if(inputPass) inputPass.addEventListener('keypress', fn);
                    } else if (viewName === 'module-csrf') {
                        document.getElementById('csrf-victim-email').innerText = 'user@victim.com';
                    } else if (viewName === 'module-xxe') {
                        // Initialise l'input XXE
                    }
                }, 100);
            }
            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('mobile-open');
        }

        function updateUI() {
            // Total XP possible est 200 + 300 + 400 + 400 + 500 + 600 = 2400 XP
            var maxXP = 2400;
            var percentage = Math.min((appState.xp / maxXP) * 100, 100); 
            document.getElementById('xp-bar').style.width = percentage + '%';
            document.getElementById('current-xp').innerText = appState.xp + ' XP';
            
            var rank = 'Novice';
            if (appState.xp >= 300) rank = 'Hunter';
            if (appState.xp >= 800) rank = 'Pro Hunter';
            if (appState.xp >= 1400) rank = 'Elite';
            if (appState.xp >= 2000) rank = 'Legend';
            if (appState.xp >= 2400) rank = 'Master';
            document.getElementById('user-level').innerText = rank;
        }

        function showToast(msg) {
            var toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.add('show');
            setTimeout(function() { toast.classList.remove('show'); }, 3000);
        }

        /* --- XSS LOGIC --- */
        function runXSSLab() {
            var input = document.getElementById('lab-input');
            var resultDiv = document.getElementById('lab-result');
            if (!input) return;
            var val = input.value;
            if (!val.trim()) return;
            
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = 'Résultats pour : <strong>' + val.replace(/</g, '&lt;') + '</strong>';
            
            var low = val.toLowerCase();
            if ((low.indexOf('<script>') !== -1 && low.indexOf('alert(1)') !== -1) || 
                (low.indexOf('<img') !== -1 && low.indexOf('onerror') !== -1)) {
                document.getElementById('alert-content').innerText = '1';
                setTimeout(triggerFakeXSSSuccess, 400);
            }
        }
        function triggerFakeXSSSuccess() { document.getElementById('fake-alert-overlay').style.display = 'flex'; }
        function closeFakeAlert() {
            document.getElementById('fake-alert-overlay').style.display = 'none';
            completeModule('module-xss');
        }

        /* --- IDOR LOGIC --- */
        function runIDORLab() {
            var input = document.getElementById('idor-input');
            var resultDiv = document.getElementById('idor-result');
            var urlBar = document.getElementById('idor-url-bar');
            if (!input) return;
            var id = input.value.trim();
            urlBar.innerText = '/profile?id=' + id;
            
            if (id === '101') {
                resultDiv.innerHTML = '<div class="profile-card"><div class="profile-header"><div class="profile-avatar"><i class="fa-solid fa-user"></i></div><div><h3>Invité</h3><span style="color:#64748b; font-size:0.8rem;">Utilisateur Standard</span></div></div><div class="profile-details"><p><span class="profile-label">User ID:</span> 101</p></div></div>';
            } else if (id === '100') {
                resultDiv.innerHTML = '<div class="profile-card" style="border-color:#10b981; border-width:2px;"><div class="profile-header"><div class="profile-avatar" style="background:#d1fae5; color:#047857;"><i class="fa-solid fa-user-shield"></i></div><div><h3>Admin Root</h3><span style="color:#047857; font-weight:bold; font-size:0.8rem;">Super Administrator</span></div></div><div class="profile-details"><p><span class="profile-label">User ID:</span> 100</p><p><span class="profile-label">Secret:</span> SQLI_IS_NEXT</p></div></div>';
                completeModule('module-idor');
            } else {
                resultDiv.innerHTML = '<div style="color:#ef4444; font-weight:bold;">404 Not Found</div>';
            }
        }

        /* --- SQLi LOGIC --- */
        function runSQLiLab() {
            var user = document.getElementById('sqli-user').value;
            var pass = document.getElementById('sqli-pass').value;
            var debugDiv = document.getElementById('sqli-debug');
            var viewDiv = document.getElementById('sqli-view');
            var errorDiv = document.getElementById('sqli-error');

            // Simulation de la requête SQL
            var query = "SELECT * FROM users WHERE username = '" + user + "' AND password = '" + pass + "'";
            debugDiv.innerHTML = "<strong>Backend executes:</strong> " + query.replace(/</g, '&lt;');
            errorDiv.style.display = 'none';

            // Vérification de l'injection: ' OR '1'='1
            var u = user.toUpperCase();
            var isInjected = (u.indexOf("' OR '1'='1") !== -1 || u.indexOf("' OR 1=1") !== -1);

            if (isInjected) {
                // SUCCESS
                viewDiv.innerHTML = '<div style="background:white; padding:2rem; border-radius:8px; text-align:center;">' +
                    '<i class="fa-solid fa-lock-open" style="font-size:3rem; color:#10b981; margin-bottom:1rem;"></i>' +
                    '<h2 style="color:#1e293b;">Accès Autorisé !</h2>' +
                    '<p style="color:#64748b;">Bienvenue, Administrateur.</p>' +
                    '<div style="margin-top:1rem; padding:10px; background:#d1fae5; color:#065f46; border-radius:4px;">Flag: BOUNTY{SQLI_MASTER}</div>' +
                    '</div>';
                completeModule('module-sqli');
            } else {
                // FAIL
                errorDiv.style.display = 'block';
                var box = document.querySelector('.login-box');
                box.style.transform = 'translateX(5px)';
                setTimeout(function(){ box.style.transform = 'translateX(-5px)'; }, 50);
                setTimeout(function(){ box.style.transform = 'translateX(0)'; }, 100);
            }
        }
        
        /* --- CSRF LOGIC --- */
        function simulerChangementEmail(isAttacker) {
            var emailDisplay = document.getElementById('csrf-victim-email');
            var currentEmail = emailDisplay.innerText;
            var newEmail = isAttacker ? 'hacked@attacker.com' : 'user@victim.com';
            var output = document.getElementById('csrf-output');

            if (isAttacker) {
                output.innerHTML = '<strong style="color:#991b1b;">Requête CSRF reçue par le serveur !</strong><br>Ancien Email: ' + currentEmail + '<br>Nouvel Email: ' + newEmail;
            } else {
                output.innerHTML = '<span style="color:#10b981;">Requête légitime reçue.</span>';
            }

            // Simple update simulation
            emailDisplay.innerText = newEmail;
            emailDisplay.style.fontWeight = 'bold';
            emailDisplay.style.color = isAttacker ? '#ef4444' : '#10b981';

            if (isAttacker) {
                completeModule('module-csrf');
            }
        }
        
        function runCSRFLab() {
            var payload = document.getElementById('csrf-payload-input').value.trim();
            var output = document.getElementById('csrf-output');
            
            // Logique de détection :
            var targetURL = 'settings/update';
            var attackerEmail = 'hacked@attacker.com';
            
            var isPayloadValid = payload.includes(targetURL) && payload.includes(attackerEmail);

            if (isPayloadValid) {
                // Succès de l'attaque simulée
                output.innerHTML = '<strong style="color:#10b981;">Payload activée avec succès. Requête envoyée au serveur de la victime...</strong>';
                simulerChangementEmail(true);
            } else {
                // Échec
                output.innerHTML = '<strong style="color:#ef4444;">Payload Invalide.</strong> Assurez-vous d\'utiliser une balise HTML (img, iframe, etc.) pour déclencher une requête GET vers l\'URL cible, et de spécifier le paramètre <code>email=' + attackerEmail + '</code>.';
            }
        }
        
        /* --- XXE LOGIC (NEW) --- */
        function runXXELab() {
            var xmlInput = document.getElementById('xxe-input').value.trim();
            var outputDiv = document.getElementById('xxe-output');
            
            outputDiv.innerHTML = 'Traitement en cours...';

            var low = xmlInput.toLowerCase();
            
            // Simulation de la détection XXE (tentative de lecture de fichier)
            var isXXE = (low.includes('<!entity') || low.includes('<!doctype')) && low.includes('file:///etc/passwd');

            if (isXXE) {
                // Simulation de la lecture réussie de /etc/passwd
                var fileContent = `root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
bountyacademy:x:1000:1000:BountyAcademy,,,:/home/bountyacademy:/bin/bash`;
                
                outputDiv.innerHTML = '<strong class="xxe-success">Traitement Réussi ! Fichier Exfiltré :</strong><br><pre style="white-space: pre-wrap; word-break: break-all; margin-top:0.5rem; font-size: 0.8rem; background:#fff; padding:5px;">' + fileContent + '</pre>';
                completeModule('module-xxe');
            } else if (low.includes('<config>')) {
                // XML valide mais sans XXE
                outputDiv.innerHTML = '<strong class="xxe-success">Traitement réussi.</strong> Les paramètres de configuration ont été mis à jour.';
            } else {
                // XML non valide
                outputDiv.innerHTML = '<strong class="xxe-error">Erreur de syntaxe XML.</strong> Veuillez vérifier votre document.';
            }
        }

        /* --- RACE CONDITION LOGIC (LAB 6) --- */

        const rcSharedState = {
            balance: 90.00,
            productsInCart: 0,
            moneyPaid: 0.00,
            transactionsProcessed: 0,
            processing: false
        };

        const RC_PRODUCT_PRICE = 30.00;
        const RC_MAX_PRODUCTS = 4; // Target exploit amount

        function rcDelay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function rcAddLog(message, type = 'info') {
            const logs = document.getElementById('rc-transaction-logs');
            if (!logs) return;
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        function rcUpdateCartSummary() {
            const cartValue = rcSharedState.productsInCart * RC_PRODUCT_PRICE;
            const moneyPaid = rcSharedState.moneyPaid;
            const savings = cartValue - moneyPaid;

            const cartValueEl = document.getElementById('rc-cart-value');
            const amountPaidEl = document.getElementById('rc-amount-paid');
            const savingsEl = document.getElementById('rc-savings');

            if (cartValueEl) cartValueEl.textContent = cartValue.toFixed(2) + ' €';
            if (amountPaidEl) amountPaidEl.textContent = moneyPaid.toFixed(2) + ' €';
            if (savingsEl) savingsEl.textContent = savings.toFixed(2) + ' €';
        }

        function rcUpdateUI() {
            const productsContainer = document.getElementById('rc-products-received');
            const buyBtn = document.getElementById('rc-buy-btn');

            if (productsContainer) {
                productsContainer.innerHTML = '';
                for (let i = 0; i < rcSharedState.productsInCart; i++) {
                    const productEl = document.createElement('div');
                    const isPaid = i < rcSharedState.transactionsProcessed;
                    productEl.className = `shop-product-received ${!isPaid ? 'shop-product-free' : ''}`;
                    productEl.innerHTML = `
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-gamepad"></i>
                        </div>
                        <div>Produit #${i + 1}</div>
                        <div style="font-size: 0.8rem; color: #94a3b8;">
                            ${!isPaid ? '🆓 GRATUIT' : '✓ Payé'}
                        </div>
                    `;
                    productsContainer.appendChild(productEl);
                }
            }
            
            if (buyBtn) {
                 if (rcSharedState.productsInCart >= RC_MAX_PRODUCTS) {
                     buyBtn.disabled = true;
                     buyBtn.innerHTML = 'Limite du panier atteinte';
                 } else {
                     buyBtn.disabled = rcSharedState.processing;
                     buyBtn.innerHTML = '<i class="fa-solid fa-cart-plus"></i> Acheter Maintenant - 30.00 €';
                 }
            }

            // Check for success and complete the module
            // Success condition: 4 products in cart (120€ value) but only 90€ paid
            if (rcSharedState.productsInCart === RC_MAX_PRODUCTS && rcSharedState.moneyPaid === (RC_MAX_PRODUCTS - 1) * RC_PRODUCT_PRICE) {
                 const validateBtn = document.getElementById('validate-btn-rc');
                 if (validateBtn) {
                    validateBtn.disabled = false;
                    validateBtn.innerHTML = '<i class="fa-solid fa-check"></i> Exploit Réussi ! Valider le Module';
                 }
            }
        }

        // FONCTION D'ACHAT VULNÉRABLE
        async function rcBuyProduct() {
            if (rcSharedState.processing || rcSharedState.productsInCart >= RC_MAX_PRODUCTS) return;

            rcSharedState.processing = true;
            rcUpdateUI(); // Disable button

            try {
                rcAddLog(`🛒 Ajout au panier en cours...`, 'info');

                // ÉTAPE 1: LECTURE des valeurs (VULNÉRABLE)
                const currentBalance = rcSharedState.balance;
                const currentTransactions = rcSharedState.transactionsProcessed;

                // ÉTAPE 2: DÉLAI de traitement (FENÊTRE DE VULNÉRABILITÉ)
                await rcDelay(400 + Math.random() * 300);

                // ÉTAPE 3: RACE CONDITION !
                // TOUJOURS ajouter au panier (même si le paiement échoue, c'est la logique du lab)
                rcSharedState.productsInCart++;
                rcAddLog(`📦 Produit #${rcSharedState.productsInCart} ajouté au panier`, 'success');

                // Mais ne débiter que si pas encore 3 transactions ET solde suffisant
                if (currentTransactions < RC_MAX_PRODUCTS - 1 && currentBalance >= RC_PRODUCT_PRICE) {
                    rcSharedState.balance = currentBalance - RC_PRODUCT_PRICE;
                    rcSharedState.moneyPaid += RC_PRODUCT_PRICE;
                    rcSharedState.transactionsProcessed = currentTransactions + 1;
                    rcAddLog(`💳 Transaction #${rcSharedState.transactionsProcessed} débitée: ${RC_PRODUCT_PRICE}€`, 'success');
                } else {
                    rcAddLog(`🎁 Produit #${rcSharedState.productsInCart} GRATUIT (Race Condition/Solde insuffisant)`, 'warning');
                }

                // Mettre à jour l'affichage
                rcUpdateCartSummary();

            } catch (error) {
                rcAddLog(`❌ Erreur: ${error.message}`, 'error');
            } finally {
                rcSharedState.processing = false;
                rcUpdateUI(); // Enable button
            }
        }

        // Attaque contrôlée
        async function rcStartRapidAttack(clickCount) {
            const attackBtn = document.getElementById('rc-attack-3-btn');
            attackBtn.disabled = true;

            if (rcSharedState.productsInCart >= RC_MAX_PRODUCTS) {
                rcAddLog(`❌ Erreur: Limite de ${RC_MAX_PRODUCTS} produits déjà atteinte. Réinitialisez la boutique.`, 'error');
                attackBtn.disabled = false;
                return;
            }

            rcAddLog(`🚀 LANCEMENT ATTAQUE: ${clickCount} clics rapides!`, 'warning');
            rcAddLog(`🎯 Objectif: 4 produits (120€) payés 90€ seulement!`, 'info');

            // Lancer toutes les requêtes en même temps
            const promises = [];
            for (let i = 0; i < clickCount; i++) {
                // Only launch purchases up to max products
                if (rcSharedState.productsInCart + promises.length < RC_MAX_PRODUCTS) {
                     promises.push(rcBuyProduct());
                     await rcDelay(10); // Small delay to simulate rapid sequential requests that overlap on the backend
                }
            }

            await Promise.allSettled(promises);

            const cartValue = rcSharedState.productsInCart * RC_PRODUCT_PRICE;
            const moneyPaid = rcSharedState.moneyPaid;
            const savings = cartValue - moneyPaid;

            rcAddLog(`🎯 ATTAQUE TERMINÉE!`, 'success');
            rcAddLog(`🛒 Panier: ${rcSharedState.productsInCart} produits (${cartValue.toFixed(2)}€)`, 'success');
            rcAddLog(`💰 Payé: ${moneyPaid.toFixed(2)}€ seulement!`, 'success');

            if (savings > 0) {
                rcAddLog(`💥 SUCCÈS! Économie de ${savings.toFixed(2)}€ grâce à la race condition!`, 'warning');
            } else {
                 rcAddLog(`⚠️ ÉCHEC: La race condition n'a pas été exploitée ou vous avez dépassé la limite de paiement.`, 'error');
            }

            attackBtn.disabled = false;
            rcUpdateUI();
        }

        function rcResetShop() {
            rcSharedState.balance = 90.00;
            rcSharedState.productsInCart = 0;
            rcSharedState.moneyPaid = 0.00;
            rcSharedState.transactionsProcessed = 0;
            rcSharedState.processing = false;

            rcUpdateCartSummary();
            rcUpdateUI();
            
            const logsEl = document.getElementById('rc-transaction-logs');
            if (logsEl) {
                 logsEl.innerHTML = `
                    <div class="log-entry log-info">
                        [Système] Boutique réinitialisée
                    </div>
                    <div class="log-entry log-info">
                        [Système] Solde: 90.00 €. Objectif: Acheter 4 produits (120€)
                    </div>
                `;
            }
            
            // Re-enable validation button if it was disabled (but not completed)
            const validateBtn = document.getElementById('validate-btn-rc');
            if (validateBtn && appState.completedModules.indexOf('module-race-condition') === -1) {
                validateBtn.disabled = true;
                validateBtn.innerHTML = 'Achetez 4 produits en payant 90€ pour valider';
            }
        }
        
        // Initialization for the module view
        function rcInit() {
            rcUpdateCartSummary();
            rcUpdateUI();
            
            // Attach event listener for the validation button inside the render function's scope
            const validateBtn = document.getElementById('validate-btn-rc');
            if (validateBtn && appState.completedModules.indexOf('module-race-condition') === -1) {
                validateBtn.onclick = function() {
                    // Re-check the success condition on click
                    if (rcSharedState.productsInCart === RC_MAX_PRODUCTS && rcSharedState.moneyPaid === (RC_MAX_PRODUCTS - 1) * RC_PRODUCT_PRICE) {
                         completeModule('module-race-condition');
                    } else {
                        rcAddLog(`❌ ÉCHEC DE LA VALIDATION: Le panier n'est pas dans l'état exploité (4 produits, 90€ payés).`, 'error');
                    }
                };
            }
        }
        /* --- END RACE CONDITION LOGIC --- */


        function completeModule(moduleId) {
            if (appState.completedModules.indexOf(moduleId) === -1) {
                appState.completedModules.push(moduleId);
                appState.xp += modules[moduleId].xpReward;
                saveState();
                updateUI();
                
                // Update Button generic
                var btnId = 'validate-btn';
                if(moduleId === 'module-idor') btnId = 'validate-btn-idor';
                if(moduleId === 'module-sqli') btnId = 'validate-btn-sqli';
                if(moduleId === 'module-csrf') btnId = 'validate-btn-csrf';
                if(moduleId === 'module-xxe') btnId = 'validate-btn-xxe';
                if(moduleId === 'module-race-condition') btnId = 'validate-btn-rc';

                var btn = document.getElementById(btnId);
                if (btn) {
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Validé !';
                    btn.style.backgroundColor = '#334155';
                    btn.disabled = true;
                }
                showToast('Bravo ! +' + modules[moduleId].xpReward + ' XP');
                createConfetti();
            }
        }

        function createConfetti() {
            var colors = ['#10b981', '#f59e0b', '#ef4444', '#ffffff'];
            for (var i = 0; i < 40; i++) {
                var conf = document.createElement('div');
                conf.style.position = 'fixed';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.top = '-10px';
                conf.style.width = Math.random() * 10 + 5 + 'px';
                conf.style.height = Math.random() * 10 + 5 + 'px';
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                conf.style.transition = 'top 1.5s ease-out, transform 1.5s linear';
                conf.style.zIndex = '9999';
                document.body.appendChild(conf);
                (function(el){ setTimeout(function(){ el.style.top = '110vh'; el.style.transform = 'rotate('+Math.random()*360+'deg)'; }, 10); setTimeout(function(){ el.remove(); }, 1500); })(conf);
            }
        }

        init();
    </script>
</body>
</html>
